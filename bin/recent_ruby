#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'recent_ruby.rb'
require 'pp'
require 'net/http'
require 'json'

class App
  include Methadone::Main
  include Methadone::CLILogging

  def self.http_get(url)
    uri = URI(url)
    Net::HTTP.start(uri.host, uri.port,
      :use_ssl => uri.scheme == 'https') do |http|
      request = Net::HTTP::Get.new uri
      response = http.request request
      response.body
    end
  end

  main do |version|
    arg :version, :optional

    version_base_url = ENV['VERSION_BASE_URL'] || "https://raw.githubusercontent.com/rbenv/ruby-build/master/share/ruby-build/"
    versions_url = ENV['VERSIONS_URL'] || "https://api.github.com/repos/rbenv/ruby-build/contents/share/ruby-build"

    minor = version.split(".")[0,2]
    puts "Downloading latest list of Rubies from Github..."

    rubies = JSON.parse(http_get(versions_url))
    puts "Comparing version numbers..."
    minor_rubies = rubies.map {|n| n["name"]}.select{|n|
      n =~ /^\d+\.\d+\.\d+(-p\d+)?$/ &&
      n.split(".")[0,2] == minor
    }

    latest = minor_rubies.sort_by {|ruby|
      a,b,c,d = *ruby.sub("-p", ".").split(".").map(&:to_i)
      [a,b,c,d || -1]
    }.last

    if version != latest
      puts "Current version is #{version}, but the latest patch release for #{minor.join(".")} is #{latest}!"
      exit 1
    end

    puts "Downloading details for #{version}..."
    details = http_get("#{version_base_url}#{version}")
    puts "Checking EOL status..."

    if details =~ / warn_eol /
      puts "EOL warning found for #{version}!"
      exit 1
    end

    puts "Ruby version check completed successfully."
  end

  version RecentRuby::VERSION

  use_log_level_option :toggle_debug_on_signal => 'USR1'

  go!
end
